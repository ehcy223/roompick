<% content_for :title, "投稿一覧" %>

<div class="container py-4">
  <h1 class="h4 mb-3">投稿一覧</h1>

  <% if @posts.present? %>
    <div class="row g-3">
      <% @posts.each do |post| %>
        <div class="col-12 col-sm-6 col-lg-4">
          <div class="card h-100 shadow-sm">

            <%# 画像（ActiveStorage or 文字列URL対応） %>
            <% if post.respond_to?(:image) && (post.image.respond_to?(:attached?) ? post.image.attached? : post.image.present?) %>
              <% if post.image.respond_to?(:attached?) %>
                <%= link_to post_path(post) do %>
                  <%= image_tag post.image, class: "card-img-top post-thumb", alt: post.title %>
                <% end %>
              <% else %>
                <%= link_to post_path(post) do %>
                  <%= image_tag post.image, class: "card-img-top post-thumb", alt: post.title %>
                <% end %>
              <% end %>
            <% else %>
              <%= link_to post_path(post) do %>
                <%= image_tag "default-image.webp", class: "card-img-top post-thumb", alt: "No image" %>
              <% end %>
            <% end %>

            <div class="card-body d-flex flex-column">
              <h3 class="h6 mb-1">
                <%= link_to post.title, post_path(post), class: "text-decoration-none" %>
              </h3>

              <%# 星評価（5段階） %>
              <% if post.respond_to?(:rating) && post.rating.present? %>
                <div class="mb-2 small text-warning" aria-label="評価 <%= post.rating %> / 5">
                  <% 1.upto(5) do |n| %>
                    <%= n <= post.rating.to_i ? "★" : "☆" %>
                  <% end %>
                </div>
              <% end %>

              <p class="text-muted small mb-2"><%= truncate(post.body.to_s, length: 80) %></p>

              <div class="mt-auto d-flex justify-content-between align-items-center small text-muted">
                <% if post.respond_to?(:category) && post.category.present? %>
                  <span class="badge bg-light text-dark"><%= post.category.name %></span>
                <% else %>
                  <span></span>
                <% end %>
                <span><%= l(post.created_at.to_date) rescue post.created_at.to_date %></span>
              </div>
            </div>

          </div>
        </div>
      <% end %>
    </div>

    <%# Kaminari/Pagy など使っていればここにページネーション %>
    <div class="mt-3">
      <%= paginate @posts if respond_to?(:paginate) %>
      <%= pagy_bootstrap_nav(@pagy).html_safe if defined?(pagy_bootstrap_nav) && @pagy %>
    </div>

  <% else %>
    <p class="text-muted">まだ投稿がありません。</p>
  <% end %>
</div>