<% content_for :title, @post.title %>

<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-9">

      <div class="card shadow-sm">
        <%# 画像（あれば大きめに表示） %>
        <% if @post.respond_to?(:image) && (@post.image.respond_to?(:attached?) ? @post.image.attached? : @post.image.present?) %>
          <div class="post-hero">
            <%# ActiveStorage なら軽量化推奨: variant(resize_to_limit: [1200, 800]) %>
            <%= image_tag(@post.image, class: "w-100 h-100 object-cover", alt: @post.title) %>
          </div>
        <% end %>

        <div class="card-body">
          <h1 class="h3 mb-2"><%= @post.title %></h1>

          <%# 評価（表示用） %>
          <% if @post.respond_to?(:rating) && @post.rating.present? %>
            <div class="mb-2 text-warning fs-5" aria-label="評価 <%= @post.rating %> / 5">
              <% 5.times do |i| %>
                <%= i < @post.rating.to_i ? "★" : "☆" %>
              <% end %>
              <span class="text-muted small ms-2"><%= @post.rating.to_i %>/5</span>
            </div>
          <% end %>

          <%# カテゴリ（ある場合） %>
          <% if @post.respond_to?(:category) && @post.category.present? %>
            <div class="mb-2">
              <span class="badge bg-secondary"><%= @post.category.name %></span>
            </div>
          <% end %>

          <div class="mb-3">
            <p class="mb-0"><%= simple_format(h(@post.body)) %></p>
          </div>

          <div class="d-flex flex-wrap gap-3 text-muted small">
            <div>作成日: <%= l(@post.created_at, format: :long) rescue @post.created_at.to_s(:long) %></div>
            <% if @post.updated_at && @post.updated_at != @post.created_at %>
              <div>更新日: <%= l(@post.updated_at, format: :long) rescue @post.updated_at.to_s(:long) %></div>
            <% end %>
          </div>

          <hr class="my-4">

          <div class="d-flex gap-2">
            <%= link_to "一覧へ戻る", posts_path, class: "btn btn-outline-secondary" %>

            <% if user_signed_in? && current_user == @post.user %>
              <%= link_to "編集", edit_post_path(@post), class: "btn btn-primary" %>
              <%= button_to "削除", @post, method: :delete,
                    data: { confirm: "本当に削除しますか？" },
                    class: "btn btn-danger" %>
            <% end %>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
  
<hr class="my-4">
<h2 class="h6">コメント</h2>

<% if user_signed_in? %>
  <%= form_with model: [@post, Comment.new], local: true do |f| %>
    <div class="mb-2">
      <%= f.text_area :content, rows: 3, class: "form-control", placeholder: "コメントを書く…" %>
    </div>
    <%= f.submit "コメントする", class: "btn btn-primary btn-sm" %>
  <% end %>
<% else %>
  <p class="text-muted small">コメントするにはログインしてください。</p>
<% end %>

<ul class="list-unstyled mt-3">
  <% @post.comments.includes(:user).order(created_at: :desc).each do |c| %>
    <li class="mb-3">
      <div class="small text-muted">
        <%= c.user&.name || c.user&.email %> ・
        <%= l(c.created_at, format: :short) rescue c.created_at %>
      </div>
      <div><%= simple_format c.content %></div>
      <% if user_signed_in? && c.user == current_user %>
        <div>
          <%= link_to "削除", post_comment_path(@post, c), method: :delete,
                      data: { confirm: "削除しますか？" }, class: "link-danger small" %>
        </div>
      <% end %>
    </li>
  <% end %>
</ul>