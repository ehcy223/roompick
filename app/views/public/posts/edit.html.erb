<% content_for :title, "投稿編集" %>

<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">

      <h1 class="h3 mb-3">投稿編集</h1>

      <div class="card shadow-sm">
        <div class="card-body">
          <%= form_with model: @post, local: true, html: { multipart: true, class: "post-form" } do |f| %>
            <%= render "public/shared/error_messages", resource: f.object %>

            <!-- タイトル -->
            <div class="mb-3">
              <%= f.label :title, "タイトル", class: "form-label" %>
              <%= f.text_field :title, class: "form-control", required: true %>
            </div>

            <!-- カテゴリ（新規と同じUI） -->
            <div class="mb-3">
              <%= f.label :category_id, "カテゴリー", class: "form-label" %>
              <%= f.collection_select :category_id,
                    Category.order(:name), :id, :name,
                    { prompt: "選択してください" },
                    { class: "form-select", required: true } %>
            </div>

            <!-- 本文 -->
            <div class="mb-3">
              <%= f.label :body, "本文", class: "form-label" %>
              <%= f.text_area :body, rows: 6, class: "form-control" %>
            </div>

            <!-- 評価（5段階）-->
            <div class="mb-3">
              <%= f.label :rating, "評価", class: "form-label" %>
              <%= f.select :rating, (1..5).to_a, { prompt: "選択してください" }, class: "form-select", required: true %>
            </div>

            <!-- 画像（現在の画像のプレビュー→新しい画像選択で差し替え） -->
            <div class="mb-3">
              <%= f.label :image, "画像アップロード", class: "form-label" %>

              <%# 現在の画像（ActiveStorage想定）。CarrierWave等ならヘルパに合わせて変更してください %>
              <% if @post.respond_to?(:image) && @post.image.present? %>
                <% if @post.image.respond_to?(:attached?) ? @post.image.attached? : @post.image.present? %>
                  <div class="mb-2">
                    <%= image_tag(@post.image, class: "img-fluid rounded", alt: "現在の画像") rescue nil %>
                  </div>
                <% end %>
              <% end %>

              <%= f.file_field :image, accept: "image/*", class: "form-control", data: { controller: "preview" } %>
              <img id="image-preview" alt="プレビュー" class="img-fluid rounded d-none mt-2" />
              <div class="form-text">新しい画像を選ぶと上書きされます。</div>
            </div>

            <!-- ボタン -->
            <div class="d-flex gap-2">
              <%= f.submit "更新する", class: "btn btn-primary btn-lg" %>
              <%= link_to "キャンセル", posts_path, class: "btn btn-outline-secondary" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- 削除ボタン（カードの下に整列） -->
      <div class="mt-3">
        <%= button_to '削除する',
                      @post,
                      method: :delete,
                      data: { confirm: '本当に削除しますか？' },
                      class: "btn btn-danger" %>
      </div>

    </div>
  </div>
</div>